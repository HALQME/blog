---
import "@/styles/pagefind.css";
---

<div
    id="search-modal"
    class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-md pt-[10vh] px-4 sm:px-6 overflow-y-auto"
>
    <div
        class="bg-gray-100 dark:bg-gray-900 rounded-lg shadow-lg mx-auto w-full max-w-xl max-h-fit overflow-y-auto"
    >
        <div class="p-2 sm:p-4">
            <div
                class="prose dark:prose-invert prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-a:no-underline hover:prose-a:text-blue-800 dark:hover:prose-a:text-blue-300 max-w-none prose-headings:font-bold prose-h1:text-3xl prose-h2:text-2xl prose-p:leading-7 prose-li:leading-7 prose-img:rounded-lg prose-pre:bg-gray-800 dark:prose-pre:bg-gray-900 prose-pre:p-4 prose-pre:rounded-lg"
            >
                <div id="search" class="search-content"></div>
            </div>
        </div>
    </div>
</div>

<script>
    import { PagefindUI } from "@pagefind/default-ui";

    function initializeSearch() {
        // 要素の取得
        const searchButton = document.getElementById("search-button");
        const searchModal = document.getElementById("search-modal");

        // すでに初期化されている場合は処理しない
        if (searchButton?.dataset.initialized === "true") {
            return;
        }

        // 検索UIの初期化
        if (document.getElementById("search")) {
            new PagefindUI({
                element: "#search",
                showImages: false,
                autofocus: true,
                pageSize: 10,
            });
        }

        // 検索ボタンクリックイベント
        searchButton?.addEventListener("click", () => {
            searchModal?.classList.remove("hidden");
            searchModal?.classList.add("flex");
            document.body.classList.add("overflow-hidden");
        });

        // 初期化フラグを設定
        if (searchButton) {
            searchButton.dataset.initialized = "true";
        }

        // モーダルの背景部分をクリックして閉じる
        searchModal?.addEventListener("click", (e) => {
            if (e.target === searchModal) {
                closeSearchModal();
            }
        });
    }

    function closeSearchModal() {
        const searchModal = document.getElementById("search-modal");
        searchModal?.classList.add("hidden");
        searchModal?.classList.remove("flex");
        document.body.classList.remove("overflow-hidden");
    }

    // グローバルのキーボードイベント（一度だけ設定）
    function setupGlobalEvents() {
        // ESCキーを押して閉じる処理
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                closeSearchModal();
            }
        });
    }

    setupGlobalEvents();

    // ページ遷移後の再初期化
    document.addEventListener("astro:page-load", initializeSearch, {
        once: false,
    });
</script>
