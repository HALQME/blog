---
import "@/styles/pagefind.css";
---

<button
    id="search-button"
    aria-label="ã‚µã‚¤ãƒˆå†…æ¤œç´¢"
    class="cursor-pointer flex flex-row text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors py-1 px-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800"
>
    ğŸ” <span class="hidden sm:block ml-1">æ¤œç´¢</span></button
>

<div id="search-modal" class="search-modal z-50">
    <div
        class="bg-gray-100 dark:bg-gray-900 rounded-lg shadow-lg p-2 sm:p-4 max-w-lg mx-auto"
    >
        <div
            class="prose dark:prose-invert prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-a:no-underline hover:prose-a:text-blue-800 dark:hover:prose-a:text-blue-300 max-w-none prose-headings:font-bold prose-h1:text-3xl prose-h2:text-2xl prose-p:leading-7 prose-li:leading-7 prose-img:rounded-lg prose-pre:bg-gray-800 dark:prose-pre:bg-gray-900 prose-pre:p-4 prose-pre:rounded-lg"
        >
            <div id="search" class="search-content"></div>
        </div>
    </div>
</div>

<script>
    import { PagefindUI } from "@pagefind/default-ui";

    function initializeSearch() {
        // è¦ç´ ã®å–å¾—
        const searchButton = document.getElementById("search-button");
        const searchModal = document.getElementById("search-modal");

        // ã™ã§ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‡¦ç†ã—ãªã„
        if (searchButton?.dataset.initialized === "true") {
            return;
        }

        // æ¤œç´¢UIã®åˆæœŸåŒ–
        if (document.getElementById("search")) {
            new PagefindUI({
                element: "#search",
                showImages: false,
                autofocus: true,
                pageSize: 10,
            });
        }

        // æ¤œç´¢ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        searchButton?.addEventListener("click", () => {
            searchModal?.classList.add("is-active");
            document.body.classList.add("search-active"); // è¿½åŠ : bodyã«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        });

        // åˆæœŸåŒ–ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        if (searchButton) {
            searchButton.dataset.initialized = "true";
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯éƒ¨åˆ†ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‰ã˜ã‚‹
        searchModal?.addEventListener("click", (e) => {
            if (e.target === searchModal) {
                searchModal.classList.remove("is-active");
                document.body.classList.remove("search-active"); // è¿½åŠ : bodyã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            }
        });
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¸€åº¦ã ã‘è¨­å®šï¼‰
    function setupGlobalEvents() {
        // ESCã‚­ãƒ¼ã‚’æŠ¼ã—ã¦é–‰ã˜ã‚‹å‡¦ç†
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                const modal = document.getElementById("search-modal");
                if (modal?.classList.contains("is-active")) {
                    modal.classList.remove("is-active");
                    document.body.classList.remove("search-active"); // è¿½åŠ : bodyã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                }
            }
        });
    }

    setupGlobalEvents();

    // ãƒšãƒ¼ã‚¸é·ç§»å¾Œã®å†åˆæœŸåŒ–
    document.addEventListener("astro:page-load", initializeSearch, {
        once: false,
    });
</script>
