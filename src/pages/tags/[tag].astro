---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const uniqueTags = [...new Set(posts.flatMap((post) => post.data.tags))];

  return uniqueTags.map((tag) => {
    const filteredPosts = posts
      .filter((post) => post.data.tags.includes(tag))
      .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
    return {
      params: { tag },
      props: { posts: filteredPosts, tag },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<Layout title={`#${tag} | Blog | HALQME`}>
  <section>
    <div class="mb-8">
      <a
        href="/tags"
        class="text-meta mb-2 inline-flex items-center text-gray-500 hover:text-gray-700"
      >
        <div class="i-lucide:arrow-left mr-1"></div>
        すべてのタグ
      </a>
      <h1 class="heading-2">
        <div class="i-lucide:tag mr-2"></div>
        #{tag}
      </h1>
      <p class="text-sub mt-2 text-gray-600">
        {posts.length} 件の記事
      </p>
    </div>

    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-2">
      {
        posts.map((post) => (
          <a href={`/blog/${post.id}/`} class="card-interactive group">
            {post.data.heroImage && (
              <img
                width={720}
                height={360}
                src={post.data.heroImage}
                alt=""
                class="mb-4 h-48 w-full rounded-sm border border-gray-200 object-cover"
              />
            )}
            <h2 class="mb-2 text-xl font-bold text-gray-900 decoration-2 underline-offset-4 group-hover:underline">
              {post.data.title}
            </h2>
            <div class="text-meta mb-4 text-gray-500">
              <div class="i-lucide:calendar mr-1" />
              <time datetime={post.data.pubDate.toISOString()}>
                {post.data.pubDate.toLocaleDateString("ja-JP")}
              </time>
            </div>
            <p class="text-sub mb-4 line-clamp-3">{post.data.description}</p>
            {post.data.tags && post.data.tags.length > 0 && (
              <div class="pointer-events-none mt-auto flex flex-wrap gap-2">
                {post.data.tags.map((t) => (
                  <span
                    class:list={[
                      "tag-base text-xs",
                      t === tag ? "tag-active" : "bg-gray-50 text-gray-600",
                    ]}
                  >
                    <div class="i-lucide:tag text-gray-400" />
                    {t}
                  </span>
                ))}
              </div>
            )}
          </a>
        ))
      }
    </div>
  </section>
</Layout>
