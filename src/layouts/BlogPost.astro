---
import Layout from "./Layout.astro";
import type { CollectionEntry } from "astro:content";
import ShareButtons from "../components/ShareButtons.astro";
import TableOfContents from "../components/TableOfContents.astro";
import type { MarkdownHeading } from "astro";

type Props = CollectionEntry<"blog">["data"] & {
  slug: string;
  readingTime?: string;
  headings?: MarkdownHeading[];
};

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  tags,
  slug,
  readingTime,
  headings,
} = Astro.props;

// OGP画像URLの生成
const ogImage = heroImage || `/ogp/${slug}.png`;
---

<Layout
  title={title}
  description={description}
  ogImage={ogImage}
  ogType="article"
  pubDate={pubDate}
  modifiedDate={updatedDate}
  tags={tags}
>
  <article class="container-article py-8">
    {
      heroImage && (
        <img
          width={1020}
          height={510}
          src={heroImage}
          alt=""
          class="border-dark shadow-card mb-8 rounded-xs border"
        />
      )
    }
    <div class="mb-8 flex flex-col justify-center gap-4 text-center">
      <h1 class="text-title" transition:name={`title-${slug}`}>{title}</h1>
      <div class="flex flex-wrap justify-center gap-4">
        <div class="text-label">
          <div class="i-lucide:calendar"></div>
          <time datetime={pubDate.toISOString()}>
            {pubDate.toLocaleDateString("ja-JP")}
          </time>
        </div>
        {
          updatedDate && (
            <div class="text-label">
              <div class="i-lucide:refresh-cw" />
              <span>Updated:</span>
              <time datetime={updatedDate.toISOString()}>
                {updatedDate.toLocaleDateString("ja-JP")}
              </time>
            </div>
          )
        }
        {
          readingTime && (
            <div class="text-label">
              <div class="i-lucide:clock" />
              <span>{readingTime}</span>
            </div>
          )
        }
      </div>
      {
        tags && tags.length > 0 && (
          <div class="flex flex-wrap justify-center gap-2">
            {tags.map((tag) => (
              <a
                href={`/tags/${tag.toLowerCase()}`}
                class="tag tag-hover"
                transition:name={`tags-${tag}`}
              >
                <div class="i-lucide:tag text-light" />
                {tag}
              </a>
            ))}
          </div>
        )
      }
      <div class="mx-auto">
        <ShareButtons path={Astro.url.pathname.toString()} title={title} />
      </div>
    </div>

    <div
      class="relative items-stretch lg:grid lg:grid-cols-[1fr_220px] lg:gap-10"
    >
      <div class="min-w-0">
        {
          headings && headings.length > 0 && (
            <details class="bg-base border-base mb-8 rounded-xs border p-4 lg:hidden">
              <summary class="no-marker flex cursor-pointer items-center select-none">
                <div class="i-lucide:list text-light mr-2" />
                <span>目次</span>
              </summary>
              <TableOfContents headings={headings} />
            </details>
          )
        }
        <div class="prose prose-lg prose-neutral dark:prose-invert max-w-none">
          <slot />
        </div>
      </div>

      {
        headings && headings.length > 0 && (
          <aside class="relative hidden font-sans lg:block">
            <TableOfContents headings={headings} />
          </aside>
        )
      }
    </div>
    {/* 記事フッター - シェアボタン */}
    <div class="mt-12 flex justify-end">
      <ShareButtons path={Astro.url.pathname.toString()} title={title} />
    </div>
  </article>
</Layout>

{/* JavaScriptスクリプトの読み込み */}
<script>
  import "../scripts/codeCopy";
</script>

<style is:global>
  summary.no-marker::-webkit-details-marker {
    display: none;
  }
  summary.no-marker::marker {
    content: none;
  }
  summary.no-marker {
    list-style: none;
  }

  .rlc-container {
    display: flex;
    flex-direction: column-reverse;
    text-decoration: none !important;
    --at-apply: "card p-3";
  }

  .rlc-title {
    --at-apply: "text-subhead mb-1 line-clamp-1";
  }

  .rlc-description {
    --at-apply: "text-body-sm line-clamp-3 text-light";
  }

  .rlc-url-container {
    --at-apply: "text-caption flex items-center gap-1";
  }

  img.rlc-favicon {
    margin: 0;
  }

  img.rlc-image {
    margin: 0;
  }
</style>
